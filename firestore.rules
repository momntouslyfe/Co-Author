/**
 * @file Firebase Security Rules for Co-Author Pro.
 *
 * @corePhilosophy This ruleset implements proper authentication-based security.
 * Users can only access their own data, while admin operations are handled server-side.
 * @dataStructure Data is organized in collections with proper access controls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // USER DATA - Authenticated users can manage their own data
    // ============================================================

    /**
     * @description Users can manage their own user document and subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;

      /**
       * @description A user can manage their own research profiles.
       * @path /users/{userId}/researchProfiles/{researchProfileId}
       */
      match /researchProfiles/{researchProfileId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own style profiles.
       * @path /users/{userId}/styleProfiles/{styleProfileId}
       */
      match /styleProfiles/{styleProfileId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own author profiles.
       * @path /users/{userId}/authorProfiles/{authorProfileId}
       */
      match /authorProfiles/{authorProfileId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own projects.
       * @path /users/{userId}/projects/{projectId}
       */
      match /projects/{projectId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;

        /**
         * @description A user can manage their own content drafts within a project.
         * @path /users/{userId}/projects/{projectId}/contentDrafts/{draftId}
         */
        match /contentDrafts/{draftId} {
          allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
        }

        /**
         * @description A user can manage their own offer drafts within a project.
         * @path /users/{userId}/projects/{projectId}/offerDrafts/{draftId}
         */
        match /offerDrafts/{draftId} {
          allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
        }

        /**
         * @description A user can manage chapters within a project.
         * @path /users/{userId}/projects/{projectId}/chapters/{chapterId}
         */
        match /chapters/{chapterId} {
          allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
        }
      }

      /**
       * @description A user can manage their own project content ideas.
       * @path /users/{userId}/projectContentIdeas/{projectId}
       */
      match /projectContentIdeas/{projectId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own project offers.
       * @path /users/{userId}/projectOffers/{projectOfferId}
       */
      match /projectOffers/{projectOfferId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own marketing funnels.
       * @path /users/{userId}/marketingFunnels/{funnelId}
       */
      match /marketingFunnels/{funnelId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own project funnels (funnel ideas per project).
       * @path /users/{userId}/projectFunnels/{projectId}
       */
      match /projectFunnels/{projectId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      /**
       * @description A user can manage their own landing page copies.
       * @path /users/{userId}/landingPageCopies/{copyId}
       */
      match /landingPageCopies/{copyId} {
        allow get, list, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ============================================================
    // USER SENSITIVE DATA - Strictly protected user-specific data
    // ============================================================

    /**
     * @description User API keys - only accessible by the owning user.
     * @path /userApiKeys/{userId}
     */
    match /userApiKeys/{userId} {
      allow get, create, update: if request.auth != null && request.auth.uid == userId;
      allow list, delete: if false;
    }

    /**
     * @description User subscriptions - only accessible by the owning user.
     * @path /userSubscriptions/{userId}
     */
    match /userSubscriptions/{userId} {
      allow get, create, update: if request.auth != null && request.auth.uid == userId;
      allow list, delete: if false;
    }

    // ============================================================
    // PAYMENT & TRANSACTIONS - User can view, server manages
    // ============================================================

    /**
     * @description Payment records - users can view their own payments.
     * @path /payments/{orderId}
     */
    match /payments/{orderId} {
      allow get: if request.auth != null && resource.data.userId == request.auth.uid;
      allow list: if request.auth != null;
      allow create, update, delete: if false;
    }

    /**
     * @description Credit transactions - users can view their own transactions.
     * @path /creditTransactions/{transactionId}
     */
    match /creditTransactions/{transactionId} {
      allow get: if request.auth != null && resource.data.userId == request.auth.uid;
      allow list: if request.auth != null;
      allow create, update, delete: if false;
    }

    /**
     * @description Coupon usage tracking - managed server-side.
     * @path /couponUsage/{usageId}
     */
    match /couponUsage/{usageId} {
      allow read, write: if false;
    }

    // ============================================================
    // PUBLIC READ COLLECTIONS - Anyone can read, admin manages
    // ============================================================

    /**
     * @description Subscription plans - public read for pricing display.
     * @path /subscriptionPlans/{planId}
     */
    match /subscriptionPlans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Addon credit plans - public read for pricing display.
     * @path /addonCreditPlans/{planId}
     */
    match /addonCreditPlans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Coupons - public read for validation.
     * @path /coupons/{couponId}
     */
    match /coupons/{couponId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Blog posts - public read for content display.
     * @path /blogs/{blogId}
     */
    match /blogs/{blogId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Currencies - public read for pricing display.
     * @path /currencies/{currencyId}
     */
    match /currencies/{currencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Currency conversions - public read for pricing calculations.
     * @path /currencyConversions/{conversionId}
     */
    match /currencyConversions/{conversionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    // ============================================================
    // ADMIN-ONLY COLLECTIONS - No client access
    // ============================================================

    /**
     * @description Admin settings - managed exclusively server-side.
     * @path /adminSettings/{settingId}
     */
    match /adminSettings/{settingId} {
      allow read, write: if false;
    }

    /**
     * @description Admin API keys - managed exclusively server-side.
     * @path /adminAPIKeys/{keyId}
     */
    match /adminAPIKeys/{keyId} {
      allow read, write: if false;
    }

    /**
     * @description Integration settings (Facebook Pixel, Email, etc.) - admin-only.
     * @path /integrationSettings/{settingId}
     */
    match /integrationSettings/{settingId} {
      allow read, write: if false;
    }

    /**
     * @description Tracking event logs - server-side analytics.
     * @path /trackingEventLogs/{logId}
     */
    match /trackingEventLogs/{logId} {
      allow read, write: if false;
    }

    /**
     * @description Email queue - server-side processing.
     * @path /emailQueue/{emailId}
     */
    match /emailQueue/{emailId} {
      allow read, write: if false;
    }

    /**
     * @description Affiliate data - managed server-side.
     * @path /affiliates/{affiliateId}
     */
    match /affiliates/{affiliateId} {
      allow read, write: if false;
    }

    /**
     * @description Affiliate referrals - managed server-side.
     * @path /affiliateReferrals/{referralId}
     */
    match /affiliateReferrals/{referralId} {
      allow read, write: if false;
    }

    /**
     * @description Affiliate payouts - managed server-side.
     * @path /affiliatePayouts/{payoutId}
     */
    match /affiliatePayouts/{payoutId} {
      allow read, write: if false;
    }
  }
}
